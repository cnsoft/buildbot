{% from 'build_line.html' import build_table %}
{% import 'forms.html' as forms %}

{% extends "layout.html" %}

{% block submenu %}
<nav class="sub-menu-container">
  <ul class="breadcrumbs-nav container-inner">
    <li>
        <a href="/">
          Home
        </a>
    </li>
    <li>
      <a href="{{ path_to_root }}buildstatus2">
          Buildstatus
      </a>
    </li>
    <li>
      <a href="{{ path_to_root }}buildstatus_s_project">
          All branches
      </a>
    </li>
    <li>
        <a href="{{ path_to_root }}builders">
          Default branch
        </a>
    </li>
    <li>
      {{ name }}
    </li>
  </ul>
</nav>
{% endblock %}

{% block content %}

 <h1>Autobahn WebSocket Broadcast Demo</h1>
      <noscript>You must enable JavaScript</noscript>
      <form>
         <p>Broadcast Message: 
          <input id="message" type="text" size="50" maxlength="50" value="Hello from Browser!"></p>
      </form>
      
      <button onclick='broadcast();'>Broadcast Message</button>

      <div id="content">
      </div>


<h1 class="main-head">
    {{ name }}
</h1>

<!--
  <p>(<a href="{{ path_to_root }}waterfall?show={{ name }}">view in waterfall</a>)</p>
-->
<div class="column-1">
<div class="column-2">

<h2 class="head-2">
  Build status

</h2>
<ul class="list">
<li>
  <span id="esttime">
            
          </span> 
{% if current %}

  
  <h2 class="small-head">
    Current job
  </h2>
  <ul>
  {% for b in current %}
    <li><a href="{{ b.link }}">{{ b.num }}</a>
    {% if b.when %}
      ETA: fds 
          {{ b.when_time }}

          [{{ b.when }}]
    {% endif %}

    {{ b.current_step }}

    {% if authz.advertiseAction('stopBuild', request) %}
      {{ forms.stop_build(b.stop_url, authz, on_all=False, short=True, label='Build') }}
    {% endif %}    
    </li>
  {% endfor %}
  </ul>
{% else %}
  <h2 class="small-head">
     current builds
  </h2> None
  
{% endif %}    
 </li>
<li>
{% if pending %}

  <h2 class="small-head">
    Pending Build Requests:
  </h2>
  <ul>
  {% for b in pending %}
    <li><small>({{ b.when }}, waiting {{ b.delay }})</small> 
    
    {% if authz.advertiseAction('cancelPendingBuild', request) %}
      {{ forms.cancel_pending_build(builder_url+"/cancelbuild", authz, short=True, id=b.id) }}
    {% endif %}    
     
    {% if b.num_changes < 4 %}
        {% for c in b.changes %}{{ c.revision|shortrev(c.repo) }}
        (<a href="{{ c.url }}">{{ c.who|email }}</a>){% if not loop.last %},{% endif %}
        {% endfor %}
    {% else %}
        ({{ b.num_changes }} changes)
    {% endif %}    

      {% if 'owner' in b.properties %}
        <b>Forced build</b>
        by {{b.properties['owner'][0]}}
        <small>{{b.properties['reason'][0]}}</small>
      {% endif %}
    </li>
  {% endfor %}
  </li>
  </ul>  
  
  {% if authz.advertiseAction('cancelPendingBuild', request) %}
    {{ forms.cancel_pending_build(builder_url+"/cancelbuild", authz, short=False, id='all') }}
  {% endif %}    
     
{% else %}
  <h2 class="small-head">
    Pending Build Requests
  </h2> None
{% endif %}
</li>
  <li>
    <h2 class="small-head"> 
      Last Message Received
    </h2> <span class="notimpl">Not implemented</span>
  </li>
</ul>
</div>
<div class="column-2 last">

<ul class="btn-list horisontal">
  <li>
    <a class="more-info grey-btn" href="#">
        Buildslaves
    </a>
        <div class="more-info-box">
          <span href="#" class="close-btn">
          </span>
          <h3>Overview</h3>
          
                <table class="table-1">
                {% if slaves %}
                <tr>
                  <th>Name</th>
                  <th>Status</th>
                  <th>Admin</th>
                </tr>
                {% endif %}
                {% for s in slaves %}
                  {%- if loop.last or loop.index0 == 0 %}
                      <tr class='last'>
                        {%- else -%}
                      <tr>
                  {%- endif -%}
                  <td><b><a href="{{ s.link|e }}">{{ s.name|e }}</a></b></td>
                  {% if s.connected %}
                    <td class="idle">connected</td>
                    <td>{{ s.admin|email if s.admin else ""}}</td>
                  {% else %}
                    <td class="offline">offline</td> 
                    <td/>
                  {% endif %}
                  </tr>
                {% else %}
                  <td>no slaves attached</td>
                {% endfor %}
                </table>
      </div>
  </li>
  <li>
      <a class="more-info grey-btn" href="#">
        Force build
      </a>
        <div class="more-info-box">
          <span href="#" class="close-btn">
          </span>
          <h3>Force build</h3>

          {% if authz.advertiseAction('forceBuild', request) and force_schedulers != {} %}
            {{ forms.force_build(builder_url+"/force", authz, request, False, force_schedulers=force_schedulers,default_props=default_props) }}
          {% endif %}          
          
      </div>
  </li>
</ul>

<div class="divider"></div>

<h2 class="head-2">
  Recent Builds
</h2>

{{ build_table(recent) }}

<!--
{% if authz.advertiseAction('pingBuilder', request) %}
  <h2>Ping slaves</h2>
  {{ forms.ping_builder(builder_url+"/ping", authz) }}
{% endif %}
-->


</div>
</div>

{% endblock %}
